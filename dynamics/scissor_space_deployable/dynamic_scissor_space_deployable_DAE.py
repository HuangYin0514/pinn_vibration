import numpy as np
import torch
from sympy import Function, Matrix, cos, lambdify, sin, symbols, zeros
from torch import nn

from utils import tensors_to_numpy, torch_linalg_solve_bug


#######################################################################
#
# constrain Phi function
#
#######################################################################
class Phi_Net(nn.Module):
    def __init__(self, config, logger):
        super(Phi_Net, self).__init__()
        self.l = config.l
        self.device = config.device
        self.dtype = config.dtype

    # Compute the Phi(q) function
    def get_phi_q(self, q):
        e0 = torch.zeros_like(q[:, 0], device=self.device, dtype=self.dtype)
        e1 = torch.ones_like(q[:, 0], device=self.device, dtype=self.dtype)

        phi_q = torch.stack(
            [
                torch.stack(
                    [
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e1,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * q[:, 0] - 2 * q[:, 15],
                        -2 * q[:, 16] + 2 * q[:, 1],
                        -2 * q[:, 17] + 2 * q[:, 2],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 0] + 2 * q[:, 15],
                        2 * q[:, 16] - 2 * q[:, 1],
                        2 * q[:, 17] - 2 * q[:, 2],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * q[:, 0] - 2 * q[:, 21],
                        2 * q[:, 1] - 2 * q[:, 22],
                        -2 * q[:, 23] + 2 * q[:, 2],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 0] + 2 * q[:, 21],
                        -2 * q[:, 1] + 2 * q[:, 22],
                        2 * q[:, 23] - 2 * q[:, 2],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 12] + 2 * q[:, 3],
                        -2 * q[:, 13] + 2 * q[:, 4],
                        -2 * q[:, 14] + 2 * q[:, 5],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 12] - 2 * q[:, 3],
                        2 * q[:, 13] - 2 * q[:, 4],
                        2 * q[:, 14] - 2 * q[:, 5],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 18] + 2 * q[:, 3],
                        -2 * q[:, 19] + 2 * q[:, 4],
                        -2 * q[:, 20] + 2 * q[:, 5],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 18] - 2 * q[:, 3],
                        2 * q[:, 19] - 2 * q[:, 4],
                        2 * q[:, 20] - 2 * q[:, 5],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 15] + 2 * q[:, 6],
                        -2 * q[:, 16] + 2 * q[:, 7],
                        -2 * q[:, 17] + 2 * q[:, 8],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 15] - 2 * q[:, 6],
                        2 * q[:, 16] - 2 * q[:, 7],
                        2 * q[:, 17] - 2 * q[:, 8],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 21] + 2 * q[:, 6],
                        -2 * q[:, 22] + 2 * q[:, 7],
                        -2 * q[:, 23] + 2 * q[:, 8],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 21] - 2 * q[:, 6],
                        2 * q[:, 22] - 2 * q[:, 7],
                        2 * q[:, 23] - 2 * q[:, 8],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 12] + 2 * q[:, 9],
                        2 * q[:, 10] - 2 * q[:, 13],
                        2 * q[:, 11] - 2 * q[:, 14],
                        2 * q[:, 12] - 2 * q[:, 9],
                        -2 * q[:, 10] + 2 * q[:, 13],
                        -2 * q[:, 11] + 2 * q[:, 14],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 18] + 2 * q[:, 9],
                        2 * q[:, 10] - 2 * q[:, 19],
                        2 * q[:, 11] - 2 * q[:, 20],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 18] - 2 * q[:, 9],
                        -2 * q[:, 10] + 2 * q[:, 19],
                        -2 * q[:, 11] + 2 * q[:, 20],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 12] - 2 * q[:, 27],
                        2 * q[:, 13] - 2 * q[:, 28],
                        2 * q[:, 14] - 2 * q[:, 29],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 12] + 2 * q[:, 27],
                        -2 * q[:, 13] + 2 * q[:, 28],
                        -2 * q[:, 14] + 2 * q[:, 29],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 12] - 2 * q[:, 33],
                        2 * q[:, 13] - 2 * q[:, 34],
                        2 * q[:, 14] - 2 * q[:, 35],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 12] + 2 * q[:, 33],
                        -2 * q[:, 13] + 2 * q[:, 34],
                        -2 * q[:, 14] + 2 * q[:, 35],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 15] - 2 * q[:, 24],
                        2 * q[:, 16] - 2 * q[:, 25],
                        2 * q[:, 17] - 2 * q[:, 26],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 15] + 2 * q[:, 24],
                        -2 * q[:, 16] + 2 * q[:, 25],
                        -2 * q[:, 17] + 2 * q[:, 26],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 15] - 2 * q[:, 30],
                        2 * q[:, 16] - 2 * q[:, 31],
                        2 * q[:, 17] - 2 * q[:, 32],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 15] + 2 * q[:, 30],
                        -2 * q[:, 16] + 2 * q[:, 31],
                        -2 * q[:, 17] + 2 * q[:, 32],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 18] - 2 * q[:, 27],
                        2 * q[:, 19] - 2 * q[:, 28],
                        2 * q[:, 20] - 2 * q[:, 29],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 18] + 2 * q[:, 27],
                        -2 * q[:, 19] + 2 * q[:, 28],
                        -2 * q[:, 20] + 2 * q[:, 29],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 18] - 2 * q[:, 33],
                        2 * q[:, 19] - 2 * q[:, 34],
                        2 * q[:, 20] - 2 * q[:, 35],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 18] + 2 * q[:, 33],
                        -2 * q[:, 19] + 2 * q[:, 34],
                        -2 * q[:, 20] + 2 * q[:, 35],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 21] - 2 * q[:, 24],
                        2 * q[:, 22] - 2 * q[:, 25],
                        2 * q[:, 23] - 2 * q[:, 26],
                        -2 * q[:, 21] + 2 * q[:, 24],
                        -2 * q[:, 22] + 2 * q[:, 25],
                        -2 * q[:, 23] + 2 * q[:, 26],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 21] - 2 * q[:, 30],
                        2 * q[:, 22] - 2 * q[:, 31],
                        2 * q[:, 23] - 2 * q[:, 32],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 21] + 2 * q[:, 30],
                        -2 * q[:, 22] + 2 * q[:, 31],
                        -2 * q[:, 23] + 2 * q[:, 32],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 24] - 2 * q[:, 39],
                        2 * q[:, 25] - 2 * q[:, 40],
                        2 * q[:, 26] - 2 * q[:, 41],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 24] + 2 * q[:, 39],
                        -2 * q[:, 25] + 2 * q[:, 40],
                        -2 * q[:, 26] + 2 * q[:, 41],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 24] - 2 * q[:, 45],
                        2 * q[:, 25] - 2 * q[:, 46],
                        2 * q[:, 26] - 2 * q[:, 47],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 24] + 2 * q[:, 45],
                        -2 * q[:, 25] + 2 * q[:, 46],
                        -2 * q[:, 26] + 2 * q[:, 47],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 27] - 2 * q[:, 36],
                        2 * q[:, 28] - 2 * q[:, 37],
                        2 * q[:, 29] - 2 * q[:, 38],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 27] + 2 * q[:, 36],
                        -2 * q[:, 28] + 2 * q[:, 37],
                        -2 * q[:, 29] + 2 * q[:, 38],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 27] - 2 * q[:, 42],
                        2 * q[:, 28] - 2 * q[:, 43],
                        2 * q[:, 29] - 2 * q[:, 44],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 27] + 2 * q[:, 42],
                        -2 * q[:, 28] + 2 * q[:, 43],
                        -2 * q[:, 29] + 2 * q[:, 44],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 30] - 2 * q[:, 39],
                        2 * q[:, 31] - 2 * q[:, 40],
                        2 * q[:, 32] - 2 * q[:, 41],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 30] + 2 * q[:, 39],
                        -2 * q[:, 31] + 2 * q[:, 40],
                        -2 * q[:, 32] + 2 * q[:, 41],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 30] - 2 * q[:, 45],
                        2 * q[:, 31] - 2 * q[:, 46],
                        2 * q[:, 32] - 2 * q[:, 47],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 30] + 2 * q[:, 45],
                        -2 * q[:, 31] + 2 * q[:, 46],
                        -2 * q[:, 32] + 2 * q[:, 47],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 33] - 2 * q[:, 36],
                        2 * q[:, 34] - 2 * q[:, 37],
                        2 * q[:, 35] - 2 * q[:, 38],
                        -2 * q[:, 33] + 2 * q[:, 36],
                        -2 * q[:, 34] + 2 * q[:, 37],
                        -2 * q[:, 35] + 2 * q[:, 38],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 33] - 2 * q[:, 42],
                        2 * q[:, 34] - 2 * q[:, 43],
                        2 * q[:, 35] - 2 * q[:, 44],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 33] + 2 * q[:, 42],
                        -2 * q[:, 34] + 2 * q[:, 43],
                        -2 * q[:, 35] + 2 * q[:, 44],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 36] - 2 * q[:, 51],
                        2 * q[:, 37] - 2 * q[:, 52],
                        2 * q[:, 38] - 2 * q[:, 53],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 36] + 2 * q[:, 51],
                        -2 * q[:, 37] + 2 * q[:, 52],
                        -2 * q[:, 38] + 2 * q[:, 53],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 36] - 2 * q[:, 57],
                        2 * q[:, 37] - 2 * q[:, 58],
                        2 * q[:, 38] - 2 * q[:, 59],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 36] + 2 * q[:, 57],
                        -2 * q[:, 37] + 2 * q[:, 58],
                        -2 * q[:, 38] + 2 * q[:, 59],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 39] - 2 * q[:, 48],
                        2 * q[:, 40] - 2 * q[:, 49],
                        2 * q[:, 41] - 2 * q[:, 50],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 39] + 2 * q[:, 48],
                        -2 * q[:, 40] + 2 * q[:, 49],
                        -2 * q[:, 41] + 2 * q[:, 50],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 39] - 2 * q[:, 54],
                        2 * q[:, 40] - 2 * q[:, 55],
                        2 * q[:, 41] - 2 * q[:, 56],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 39] + 2 * q[:, 54],
                        -2 * q[:, 40] + 2 * q[:, 55],
                        -2 * q[:, 41] + 2 * q[:, 56],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 42] - 2 * q[:, 51],
                        2 * q[:, 43] - 2 * q[:, 52],
                        2 * q[:, 44] - 2 * q[:, 53],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 42] + 2 * q[:, 51],
                        -2 * q[:, 43] + 2 * q[:, 52],
                        -2 * q[:, 44] + 2 * q[:, 53],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 42] - 2 * q[:, 57],
                        2 * q[:, 43] - 2 * q[:, 58],
                        2 * q[:, 44] - 2 * q[:, 59],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 42] + 2 * q[:, 57],
                        -2 * q[:, 43] + 2 * q[:, 58],
                        -2 * q[:, 44] + 2 * q[:, 59],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 45] - 2 * q[:, 48],
                        2 * q[:, 46] - 2 * q[:, 49],
                        2 * q[:, 47] - 2 * q[:, 50],
                        -2 * q[:, 45] + 2 * q[:, 48],
                        -2 * q[:, 46] + 2 * q[:, 49],
                        -2 * q[:, 47] + 2 * q[:, 50],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 45] - 2 * q[:, 54],
                        2 * q[:, 46] - 2 * q[:, 55],
                        2 * q[:, 47] - 2 * q[:, 56],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 45] + 2 * q[:, 54],
                        -2 * q[:, 46] + 2 * q[:, 55],
                        -2 * q[:, 47] + 2 * q[:, 56],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e1,
                        e0,
                        e0,
                        -e1,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 48] - 2 * q[:, 63],
                        2 * q[:, 49] - 2 * q[:, 64],
                        2 * q[:, 50] - 2 * q[:, 65],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 48] + 2 * q[:, 63],
                        -2 * q[:, 49] + 2 * q[:, 64],
                        -2 * q[:, 50] + 2 * q[:, 65],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 48] - 2 * q[:, 69],
                        2 * q[:, 49] - 2 * q[:, 70],
                        2 * q[:, 50] - 2 * q[:, 71],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 48] + 2 * q[:, 69],
                        -2 * q[:, 49] + 2 * q[:, 70],
                        -2 * q[:, 50] + 2 * q[:, 71],
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 51] - 2 * q[:, 60],
                        2 * q[:, 52] - 2 * q[:, 61],
                        2 * q[:, 53] - 2 * q[:, 62],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 51] + 2 * q[:, 60],
                        -2 * q[:, 52] + 2 * q[:, 61],
                        -2 * q[:, 53] + 2 * q[:, 62],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 51] - 2 * q[:, 66],
                        2 * q[:, 52] - 2 * q[:, 67],
                        2 * q[:, 53] - 2 * q[:, 68],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 51] + 2 * q[:, 66],
                        -2 * q[:, 52] + 2 * q[:, 67],
                        -2 * q[:, 53] + 2 * q[:, 68],
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 54] - 2 * q[:, 63],
                        2 * q[:, 55] - 2 * q[:, 64],
                        2 * q[:, 56] - 2 * q[:, 65],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 54] + 2 * q[:, 63],
                        -2 * q[:, 55] + 2 * q[:, 64],
                        -2 * q[:, 56] + 2 * q[:, 65],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 54] - 2 * q[:, 69],
                        2 * q[:, 55] - 2 * q[:, 70],
                        2 * q[:, 56] - 2 * q[:, 71],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 54] + 2 * q[:, 69],
                        -2 * q[:, 55] + 2 * q[:, 70],
                        -2 * q[:, 56] + 2 * q[:, 71],
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 57] - 2 * q[:, 60],
                        2 * q[:, 58] - 2 * q[:, 61],
                        2 * q[:, 59] - 2 * q[:, 62],
                        -2 * q[:, 57] + 2 * q[:, 60],
                        -2 * q[:, 58] + 2 * q[:, 61],
                        -2 * q[:, 59] + 2 * q[:, 62],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        2 * q[:, 57] - 2 * q[:, 66],
                        2 * q[:, 58] - 2 * q[:, 67],
                        2 * q[:, 59] - 2 * q[:, 68],
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        e0,
                        -2 * q[:, 57] + 2 * q[:, 66],
                        -2 * q[:, 58] + 2 * q[:, 67],
                        -2 * q[:, 59] + 2 * q[:, 68],
                        e0,
                        e0,
                        e0,
                    ],
                    dim=-1,
                ),
            ],
            dim=1,
        )

        return phi_q  # (bs, len_lam, q_dim) -> (bs, 29, 24)

    # Compute the Phi(q, qt, qtt) function
    # shape(bs, constrain len)
    def get_phi_q_qt_q_qt(self, q, qt):
        e0 = torch.zeros_like(qt[:, 0])

        phi_q_qt_q_qt = torch.cat(
            [
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack(
                    [
                        2 * qt[:, 0] * (qt[:, 0] - qt[:, 15])
                        - 2 * qt[:, 15] * (qt[:, 0] - qt[:, 15])
                        + 2 * qt[:, 16] * (qt[:, 16] - qt[:, 1])
                        + 2 * qt[:, 17] * (qt[:, 17] - qt[:, 2])
                        - 2 * qt[:, 1] * (qt[:, 16] - qt[:, 1])
                        - 2 * qt[:, 2] * (qt[:, 17] - qt[:, 2])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 0] * (qt[:, 0] - qt[:, 21])
                        + 2 * qt[:, 1] * (qt[:, 1] - qt[:, 22])
                        - 2 * qt[:, 21] * (qt[:, 0] - qt[:, 21])
                        - 2 * qt[:, 22] * (qt[:, 1] - qt[:, 22])
                        + 2 * qt[:, 23] * (qt[:, 23] - qt[:, 2])
                        - 2 * qt[:, 2] * (qt[:, 23] - qt[:, 2])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 12] * (qt[:, 12] - qt[:, 3])
                        + 2 * qt[:, 13] * (qt[:, 13] - qt[:, 4])
                        + 2 * qt[:, 14] * (qt[:, 14] - qt[:, 5])
                        - 2 * qt[:, 3] * (qt[:, 12] - qt[:, 3])
                        - 2 * qt[:, 4] * (qt[:, 13] - qt[:, 4])
                        - 2 * qt[:, 5] * (qt[:, 14] - qt[:, 5])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 18] * (qt[:, 18] - qt[:, 3])
                        + 2 * qt[:, 19] * (qt[:, 19] - qt[:, 4])
                        + 2 * qt[:, 20] * (qt[:, 20] - qt[:, 5])
                        - 2 * qt[:, 3] * (qt[:, 18] - qt[:, 3])
                        - 2 * qt[:, 4] * (qt[:, 19] - qt[:, 4])
                        - 2 * qt[:, 5] * (qt[:, 20] - qt[:, 5])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 15] * (qt[:, 15] - qt[:, 6])
                        + 2 * qt[:, 16] * (qt[:, 16] - qt[:, 7])
                        + 2 * qt[:, 17] * (qt[:, 17] - qt[:, 8])
                        - 2 * qt[:, 6] * (qt[:, 15] - qt[:, 6])
                        - 2 * qt[:, 7] * (qt[:, 16] - qt[:, 7])
                        - 2 * qt[:, 8] * (qt[:, 17] - qt[:, 8])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 21] * (qt[:, 21] - qt[:, 6])
                        + 2 * qt[:, 22] * (qt[:, 22] - qt[:, 7])
                        + 2 * qt[:, 23] * (qt[:, 23] - qt[:, 8])
                        - 2 * qt[:, 6] * (qt[:, 21] - qt[:, 6])
                        - 2 * qt[:, 7] * (qt[:, 22] - qt[:, 7])
                        - 2 * qt[:, 8] * (qt[:, 23] - qt[:, 8])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 10] * (qt[:, 10] - qt[:, 13])
                        + 2 * qt[:, 11] * (qt[:, 11] - qt[:, 14])
                        + 2 * qt[:, 12] * (qt[:, 12] - qt[:, 9])
                        - 2 * qt[:, 13] * (qt[:, 10] - qt[:, 13])
                        - 2 * qt[:, 14] * (qt[:, 11] - qt[:, 14])
                        - 2 * qt[:, 9] * (qt[:, 12] - qt[:, 9])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 10] * (qt[:, 10] - qt[:, 19])
                        + 2 * qt[:, 11] * (qt[:, 11] - qt[:, 20])
                        + 2 * qt[:, 18] * (qt[:, 18] - qt[:, 9])
                        - 2 * qt[:, 19] * (qt[:, 10] - qt[:, 19])
                        - 2 * qt[:, 20] * (qt[:, 11] - qt[:, 20])
                        - 2 * qt[:, 9] * (qt[:, 18] - qt[:, 9])
                    ],
                    dim=-1,
                ),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack(
                    [
                        2 * qt[:, 12] * (qt[:, 12] - qt[:, 27])
                        + 2 * qt[:, 13] * (qt[:, 13] - qt[:, 28])
                        + 2 * qt[:, 14] * (qt[:, 14] - qt[:, 29])
                        - 2 * qt[:, 27] * (qt[:, 12] - qt[:, 27])
                        - 2 * qt[:, 28] * (qt[:, 13] - qt[:, 28])
                        - 2 * qt[:, 29] * (qt[:, 14] - qt[:, 29])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 12] * (qt[:, 12] - qt[:, 33])
                        + 2 * qt[:, 13] * (qt[:, 13] - qt[:, 34])
                        + 2 * qt[:, 14] * (qt[:, 14] - qt[:, 35])
                        - 2 * qt[:, 33] * (qt[:, 12] - qt[:, 33])
                        - 2 * qt[:, 34] * (qt[:, 13] - qt[:, 34])
                        - 2 * qt[:, 35] * (qt[:, 14] - qt[:, 35])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 15] * (qt[:, 15] - qt[:, 24])
                        + 2 * qt[:, 16] * (qt[:, 16] - qt[:, 25])
                        + 2 * qt[:, 17] * (qt[:, 17] - qt[:, 26])
                        - 2 * qt[:, 24] * (qt[:, 15] - qt[:, 24])
                        - 2 * qt[:, 25] * (qt[:, 16] - qt[:, 25])
                        - 2 * qt[:, 26] * (qt[:, 17] - qt[:, 26])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 15] * (qt[:, 15] - qt[:, 30])
                        + 2 * qt[:, 16] * (qt[:, 16] - qt[:, 31])
                        + 2 * qt[:, 17] * (qt[:, 17] - qt[:, 32])
                        - 2 * qt[:, 30] * (qt[:, 15] - qt[:, 30])
                        - 2 * qt[:, 31] * (qt[:, 16] - qt[:, 31])
                        - 2 * qt[:, 32] * (qt[:, 17] - qt[:, 32])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 18] * (qt[:, 18] - qt[:, 27])
                        + 2 * qt[:, 19] * (qt[:, 19] - qt[:, 28])
                        + 2 * qt[:, 20] * (qt[:, 20] - qt[:, 29])
                        - 2 * qt[:, 27] * (qt[:, 18] - qt[:, 27])
                        - 2 * qt[:, 28] * (qt[:, 19] - qt[:, 28])
                        - 2 * qt[:, 29] * (qt[:, 20] - qt[:, 29])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 18] * (qt[:, 18] - qt[:, 33])
                        + 2 * qt[:, 19] * (qt[:, 19] - qt[:, 34])
                        + 2 * qt[:, 20] * (qt[:, 20] - qt[:, 35])
                        - 2 * qt[:, 33] * (qt[:, 18] - qt[:, 33])
                        - 2 * qt[:, 34] * (qt[:, 19] - qt[:, 34])
                        - 2 * qt[:, 35] * (qt[:, 20] - qt[:, 35])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 21] * (qt[:, 21] - qt[:, 24])
                        + 2 * qt[:, 22] * (qt[:, 22] - qt[:, 25])
                        + 2 * qt[:, 23] * (qt[:, 23] - qt[:, 26])
                        - 2 * qt[:, 24] * (qt[:, 21] - qt[:, 24])
                        - 2 * qt[:, 25] * (qt[:, 22] - qt[:, 25])
                        - 2 * qt[:, 26] * (qt[:, 23] - qt[:, 26])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 21] * (qt[:, 21] - qt[:, 30])
                        + 2 * qt[:, 22] * (qt[:, 22] - qt[:, 31])
                        + 2 * qt[:, 23] * (qt[:, 23] - qt[:, 32])
                        - 2 * qt[:, 30] * (qt[:, 21] - qt[:, 30])
                        - 2 * qt[:, 31] * (qt[:, 22] - qt[:, 31])
                        - 2 * qt[:, 32] * (qt[:, 23] - qt[:, 32])
                    ],
                    dim=-1,
                ),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack(
                    [
                        2 * qt[:, 24] * (qt[:, 24] - qt[:, 39])
                        + 2 * qt[:, 25] * (qt[:, 25] - qt[:, 40])
                        + 2 * qt[:, 26] * (qt[:, 26] - qt[:, 41])
                        - 2 * qt[:, 39] * (qt[:, 24] - qt[:, 39])
                        - 2 * qt[:, 40] * (qt[:, 25] - qt[:, 40])
                        - 2 * qt[:, 41] * (qt[:, 26] - qt[:, 41])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 24] * (qt[:, 24] - qt[:, 45])
                        + 2 * qt[:, 25] * (qt[:, 25] - qt[:, 46])
                        + 2 * qt[:, 26] * (qt[:, 26] - qt[:, 47])
                        - 2 * qt[:, 45] * (qt[:, 24] - qt[:, 45])
                        - 2 * qt[:, 46] * (qt[:, 25] - qt[:, 46])
                        - 2 * qt[:, 47] * (qt[:, 26] - qt[:, 47])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 27] * (qt[:, 27] - qt[:, 36])
                        + 2 * qt[:, 28] * (qt[:, 28] - qt[:, 37])
                        + 2 * qt[:, 29] * (qt[:, 29] - qt[:, 38])
                        - 2 * qt[:, 36] * (qt[:, 27] - qt[:, 36])
                        - 2 * qt[:, 37] * (qt[:, 28] - qt[:, 37])
                        - 2 * qt[:, 38] * (qt[:, 29] - qt[:, 38])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 27] * (qt[:, 27] - qt[:, 42])
                        + 2 * qt[:, 28] * (qt[:, 28] - qt[:, 43])
                        + 2 * qt[:, 29] * (qt[:, 29] - qt[:, 44])
                        - 2 * qt[:, 42] * (qt[:, 27] - qt[:, 42])
                        - 2 * qt[:, 43] * (qt[:, 28] - qt[:, 43])
                        - 2 * qt[:, 44] * (qt[:, 29] - qt[:, 44])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 30] * (qt[:, 30] - qt[:, 39])
                        + 2 * qt[:, 31] * (qt[:, 31] - qt[:, 40])
                        + 2 * qt[:, 32] * (qt[:, 32] - qt[:, 41])
                        - 2 * qt[:, 39] * (qt[:, 30] - qt[:, 39])
                        - 2 * qt[:, 40] * (qt[:, 31] - qt[:, 40])
                        - 2 * qt[:, 41] * (qt[:, 32] - qt[:, 41])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 30] * (qt[:, 30] - qt[:, 45])
                        + 2 * qt[:, 31] * (qt[:, 31] - qt[:, 46])
                        + 2 * qt[:, 32] * (qt[:, 32] - qt[:, 47])
                        - 2 * qt[:, 45] * (qt[:, 30] - qt[:, 45])
                        - 2 * qt[:, 46] * (qt[:, 31] - qt[:, 46])
                        - 2 * qt[:, 47] * (qt[:, 32] - qt[:, 47])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 33] * (qt[:, 33] - qt[:, 36])
                        + 2 * qt[:, 34] * (qt[:, 34] - qt[:, 37])
                        + 2 * qt[:, 35] * (qt[:, 35] - qt[:, 38])
                        - 2 * qt[:, 36] * (qt[:, 33] - qt[:, 36])
                        - 2 * qt[:, 37] * (qt[:, 34] - qt[:, 37])
                        - 2 * qt[:, 38] * (qt[:, 35] - qt[:, 38])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 33] * (qt[:, 33] - qt[:, 42])
                        + 2 * qt[:, 34] * (qt[:, 34] - qt[:, 43])
                        + 2 * qt[:, 35] * (qt[:, 35] - qt[:, 44])
                        - 2 * qt[:, 42] * (qt[:, 33] - qt[:, 42])
                        - 2 * qt[:, 43] * (qt[:, 34] - qt[:, 43])
                        - 2 * qt[:, 44] * (qt[:, 35] - qt[:, 44])
                    ],
                    dim=-1,
                ),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack(
                    [
                        2 * qt[:, 36] * (qt[:, 36] - qt[:, 51])
                        + 2 * qt[:, 37] * (qt[:, 37] - qt[:, 52])
                        + 2 * qt[:, 38] * (qt[:, 38] - qt[:, 53])
                        - 2 * qt[:, 51] * (qt[:, 36] - qt[:, 51])
                        - 2 * qt[:, 52] * (qt[:, 37] - qt[:, 52])
                        - 2 * qt[:, 53] * (qt[:, 38] - qt[:, 53])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 36] * (qt[:, 36] - qt[:, 57])
                        + 2 * qt[:, 37] * (qt[:, 37] - qt[:, 58])
                        + 2 * qt[:, 38] * (qt[:, 38] - qt[:, 59])
                        - 2 * qt[:, 57] * (qt[:, 36] - qt[:, 57])
                        - 2 * qt[:, 58] * (qt[:, 37] - qt[:, 58])
                        - 2 * qt[:, 59] * (qt[:, 38] - qt[:, 59])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 39] * (qt[:, 39] - qt[:, 48])
                        + 2 * qt[:, 40] * (qt[:, 40] - qt[:, 49])
                        + 2 * qt[:, 41] * (qt[:, 41] - qt[:, 50])
                        - 2 * qt[:, 48] * (qt[:, 39] - qt[:, 48])
                        - 2 * qt[:, 49] * (qt[:, 40] - qt[:, 49])
                        - 2 * qt[:, 50] * (qt[:, 41] - qt[:, 50])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 39] * (qt[:, 39] - qt[:, 54])
                        + 2 * qt[:, 40] * (qt[:, 40] - qt[:, 55])
                        + 2 * qt[:, 41] * (qt[:, 41] - qt[:, 56])
                        - 2 * qt[:, 54] * (qt[:, 39] - qt[:, 54])
                        - 2 * qt[:, 55] * (qt[:, 40] - qt[:, 55])
                        - 2 * qt[:, 56] * (qt[:, 41] - qt[:, 56])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 42] * (qt[:, 42] - qt[:, 51])
                        + 2 * qt[:, 43] * (qt[:, 43] - qt[:, 52])
                        + 2 * qt[:, 44] * (qt[:, 44] - qt[:, 53])
                        - 2 * qt[:, 51] * (qt[:, 42] - qt[:, 51])
                        - 2 * qt[:, 52] * (qt[:, 43] - qt[:, 52])
                        - 2 * qt[:, 53] * (qt[:, 44] - qt[:, 53])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 42] * (qt[:, 42] - qt[:, 57])
                        + 2 * qt[:, 43] * (qt[:, 43] - qt[:, 58])
                        + 2 * qt[:, 44] * (qt[:, 44] - qt[:, 59])
                        - 2 * qt[:, 57] * (qt[:, 42] - qt[:, 57])
                        - 2 * qt[:, 58] * (qt[:, 43] - qt[:, 58])
                        - 2 * qt[:, 59] * (qt[:, 44] - qt[:, 59])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 45] * (qt[:, 45] - qt[:, 48])
                        + 2 * qt[:, 46] * (qt[:, 46] - qt[:, 49])
                        + 2 * qt[:, 47] * (qt[:, 47] - qt[:, 50])
                        - 2 * qt[:, 48] * (qt[:, 45] - qt[:, 48])
                        - 2 * qt[:, 49] * (qt[:, 46] - qt[:, 49])
                        - 2 * qt[:, 50] * (qt[:, 47] - qt[:, 50])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 45] * (qt[:, 45] - qt[:, 54])
                        + 2 * qt[:, 46] * (qt[:, 46] - qt[:, 55])
                        + 2 * qt[:, 47] * (qt[:, 47] - qt[:, 56])
                        - 2 * qt[:, 54] * (qt[:, 45] - qt[:, 54])
                        - 2 * qt[:, 55] * (qt[:, 46] - qt[:, 55])
                        - 2 * qt[:, 56] * (qt[:, 47] - qt[:, 56])
                    ],
                    dim=-1,
                ),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack([e0], dim=-1),
                torch.stack(
                    [
                        2 * qt[:, 48] * (qt[:, 48] - qt[:, 63])
                        + 2 * qt[:, 49] * (qt[:, 49] - qt[:, 64])
                        + 2 * qt[:, 50] * (qt[:, 50] - qt[:, 65])
                        - 2 * qt[:, 63] * (qt[:, 48] - qt[:, 63])
                        - 2 * qt[:, 64] * (qt[:, 49] - qt[:, 64])
                        - 2 * qt[:, 65] * (qt[:, 50] - qt[:, 65])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 48] * (qt[:, 48] - qt[:, 69])
                        + 2 * qt[:, 49] * (qt[:, 49] - qt[:, 70])
                        + 2 * qt[:, 50] * (qt[:, 50] - qt[:, 71])
                        - 2 * qt[:, 69] * (qt[:, 48] - qt[:, 69])
                        - 2 * qt[:, 70] * (qt[:, 49] - qt[:, 70])
                        - 2 * qt[:, 71] * (qt[:, 50] - qt[:, 71])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 51] * (qt[:, 51] - qt[:, 60])
                        + 2 * qt[:, 52] * (qt[:, 52] - qt[:, 61])
                        + 2 * qt[:, 53] * (qt[:, 53] - qt[:, 62])
                        - 2 * qt[:, 60] * (qt[:, 51] - qt[:, 60])
                        - 2 * qt[:, 61] * (qt[:, 52] - qt[:, 61])
                        - 2 * qt[:, 62] * (qt[:, 53] - qt[:, 62])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 51] * (qt[:, 51] - qt[:, 66])
                        + 2 * qt[:, 52] * (qt[:, 52] - qt[:, 67])
                        + 2 * qt[:, 53] * (qt[:, 53] - qt[:, 68])
                        - 2 * qt[:, 66] * (qt[:, 51] - qt[:, 66])
                        - 2 * qt[:, 67] * (qt[:, 52] - qt[:, 67])
                        - 2 * qt[:, 68] * (qt[:, 53] - qt[:, 68])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 54] * (qt[:, 54] - qt[:, 63])
                        + 2 * qt[:, 55] * (qt[:, 55] - qt[:, 64])
                        + 2 * qt[:, 56] * (qt[:, 56] - qt[:, 65])
                        - 2 * qt[:, 63] * (qt[:, 54] - qt[:, 63])
                        - 2 * qt[:, 64] * (qt[:, 55] - qt[:, 64])
                        - 2 * qt[:, 65] * (qt[:, 56] - qt[:, 65])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 54] * (qt[:, 54] - qt[:, 69])
                        + 2 * qt[:, 55] * (qt[:, 55] - qt[:, 70])
                        + 2 * qt[:, 56] * (qt[:, 56] - qt[:, 71])
                        - 2 * qt[:, 69] * (qt[:, 54] - qt[:, 69])
                        - 2 * qt[:, 70] * (qt[:, 55] - qt[:, 70])
                        - 2 * qt[:, 71] * (qt[:, 56] - qt[:, 71])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 57] * (qt[:, 57] - qt[:, 60])
                        + 2 * qt[:, 58] * (qt[:, 58] - qt[:, 61])
                        + 2 * qt[:, 59] * (qt[:, 59] - qt[:, 62])
                        - 2 * qt[:, 60] * (qt[:, 57] - qt[:, 60])
                        - 2 * qt[:, 61] * (qt[:, 58] - qt[:, 61])
                        - 2 * qt[:, 62] * (qt[:, 59] - qt[:, 62])
                    ],
                    dim=-1,
                ),
                torch.stack(
                    [
                        2 * qt[:, 57] * (qt[:, 57] - qt[:, 66])
                        + 2 * qt[:, 58] * (qt[:, 58] - qt[:, 67])
                        + 2 * qt[:, 59] * (qt[:, 59] - qt[:, 68])
                        - 2 * qt[:, 66] * (qt[:, 57] - qt[:, 66])
                        - 2 * qt[:, 67] * (qt[:, 58] - qt[:, 67])
                        - 2 * qt[:, 68] * (qt[:, 59] - qt[:, 68])
                    ],
                    dim=-1,
                ),
            ],
            dim=1,
        )

        return phi_q_qt_q_qt  # (bs, len_lam) -> (bs, 29)


#######################################################################
#
# force F function
#
#######################################################################
class F_Net(nn.Module):
    def __init__(self, config, logger):
        super(F_Net, self).__init__()

        self.device = config.device
        self.dtype = config.dtype

        self.unitnum = config.unitnum
        self.F_a = config.F_a
        self.F_f = config.F_f
        self.F_r = config.F_r

    # Compute the force F(t, coords)
    def forward(self, t, coords):
        bs, num_states = coords.shape
        t = t.reshape(-1, 1)
        F = torch.zeros(12 * (self.unitnum + 1), device=self.device, dtype=self.dtype)

        F[0:12] = torch.tensor(
            [
                -self.F_a * self.F_f,
                self.F_a * self.F_f,
                0,
                -self.F_a * self.F_f,
                -self.F_a * self.F_f,
                0,
                self.F_a * self.F_f,
                -self.F_a * self.F_f,
                0,
                self.F_a * self.F_f,
                self.F_a * self.F_f,
                0,
            ],
            device=self.device,
            dtype=self.dtype,
        )
        F[12 * self.unitnum : 12 * self.unitnum + 12] = torch.tensor(
            [
                0,
                0,
                -self.F_r,
                0,
                0,
                -self.F_r,
                0,
                0,
                -self.F_r,
                0,
                0,
                -self.F_r,
            ],
            device=self.device,
            dtype=self.dtype,
        )
        F = F.reshape(1, -1).repeat(bs, 1)

        return F


#######################################################################
#
# mass M function
#
#######################################################################
class M_Net(nn.Module):
    def __init__(self, config, logger):
        super(M_Net, self).__init__()

        self.device = config.device
        self.dtype = config.dtype

        self.unitnum = config.unitnum

        self.l = config.l
        self.l1 = self.l[0]  # 斜杆
        self.l2 = self.l[1]  # 横杆

        self.A = config.M_A
        self.rho = config.M_rho

    # Compute the mass matrix M(q)
    def forward(self, q):
        bs, states = q.shape
        e3 = torch.diag(torch.ones(3, device=self.device, dtype=self.dtype))

        M = torch.zeros(
            4 * 3 * (self.unitnum + 1),
            4 * 3 * (self.unitnum + 1),
            device=self.device,
            dtype=self.dtype,
        )

        # 横杆
        for i in range(self.unitnum + 1):
            # 12类
            M[
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
            ] = (
                M[
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                ]
                + self.l2 * 2 * e3
            )
            M[
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
            ] = (
                M[
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                ]
                + self.l2 * e3
            )
            M[
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
            ] = (
                M[
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                ]
                + self.l2 * e3
            )
            M[
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
            ] = (
                M[
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                ]
                + self.l2 * 2 * e3
            )

            # 23类
            M[
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
            ] = (
                M[
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                ]
                + self.l2 * 2 * e3
            )
            M[
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
            ] = (
                M[
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                ]
                + self.l2 * e3
            )
            M[
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
            ] = (
                M[
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                ]
                + self.l2 * e3
            )
            M[
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
            ] = (
                M[
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                ]
                + self.l2 * 2 * e3
            )

            # 34类
            M[
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
            ] = (
                M[
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                ]
                + self.l2 * 2 * e3
            )
            M[
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
            ] = (
                M[
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                ]
                + self.l2 * e3
            )
            M[
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
            ] = (
                M[
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                ]
                + self.l2 * e3
            )
            M[
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
            ] = (
                M[
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                ]
                + self.l2 * 2 * e3
            )

            # 14类
            M[
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
            ] = (
                M[
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                ]
                + self.l2 * 2 * e3
            )
            M[
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
            ] = (
                M[
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                ]
                + self.l2 * e3
            )
            M[
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
            ] = (
                M[
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                ]
                + self.l2 * e3
            )
            M[
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
            ] = (
                M[
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                ]
                + self.l2 * 2 * e3
            )

        # 剪杆
        for i in range(self.unitnum):
            # 16类
            M[
                3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
                3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
            ] = (
                M[
                    3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
                    3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
                ]
                + self.l1 * 2 * e3
            )
            M[
                3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
            ] = (
                M[
                    3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
            ] = (
                M[
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                    3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
            ] = (
                M[
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                ]
                + self.l1 * 2 * e3
            )

            # 25
            M[
                3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
                3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
            ] = (
                M[
                    3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
                    3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
                ]
                + self.l1 * 2 * e3
            )
            M[
                3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
            ] = (
                M[
                    3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
            ] = (
                M[
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                    3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
            ] = (
                M[
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                ]
                + self.l1 * 2 * e3
            )

            # 27
            M[
                3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
                3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
            ] = (
                M[
                    3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
                    3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
                ]
                + self.l1 * 2 * e3
            )
            M[
                3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
            ] = (
                M[
                    3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
            ] = (
                M[
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                    3 * ((4 * i + 6) - 1) : 3 * (4 * i + 6),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
            ] = (
                M[
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                ]
                + self.l1 * 2 * e3
            )

            # 36
            M[
                3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
                3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
            ] = (
                M[
                    3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
                    3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
                ]
                + self.l1 * 2 * e3
            )
            M[
                3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
            ] = (
                M[
                    3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
            ] = (
                M[
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                    3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
            ] = (
                M[
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                    3 * ((4 * i + 2) - 1) : 3 * (4 * i + 2),
                ]
                + self.l1 * 2 * e3
            )

            # 38
            M[
                3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
                3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
            ] = (
                M[
                    3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
                    3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
                ]
                + self.l1 * 2 * e3
            )
            M[
                3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
            ] = (
                M[
                    3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
            ] = (
                M[
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                    3 * ((4 * i + 7) - 1) : 3 * (4 * i + 7),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
            ] = (
                M[
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                ]
                + self.l1 * 2 * e3
            )

            # 47
            M[
                3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
                3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
            ] = (
                M[
                    3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
                    3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
                ]
                + self.l1 * 2 * e3
            )
            M[
                3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
            ] = (
                M[
                    3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
            ] = (
                M[
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                    3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
            ] = (
                M[
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                    3 * ((4 * i + 3) - 1) : 3 * (4 * i + 3),
                ]
                + self.l1 * 2 * e3
            )

            # 45
            M[
                3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
                3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
            ] = (
                M[
                    3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
                    3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
                ]
                + self.l1 * 2 * e3
            )
            M[
                3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
            ] = (
                M[
                    3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
            ] = (
                M[
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                    3 * ((4 * i + 8) - 1) : 3 * (4 * i + 8),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
            ] = (
                M[
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                    3 * ((4 * i + 1) - 1) : 3 * (4 * i + 1),
                ]
                + self.l1 * 2 * e3
            )

            # 16类
            M[
                3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
                3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
            ] = (
                M[
                    3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
                    3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
                ]
                + self.l1 * 2 * e3
            )
            M[
                3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
            ] = (
                M[
                    3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
            ] = (
                M[
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                    3 * ((4 * i + 5) - 1) : 3 * (4 * i + 5),
                ]
                + self.l1 * e3
            )
            M[
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
            ] = (
                M[
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                    3 * ((4 * i + 4) - 1) : 3 * (4 * i + 4),
                ]
                + self.l1 * 2 * e3
            )

        M = 1 / 6 * self.rho * self.A * M

        M_repeat = M.repeat(bs, 1, 1)
        return M_repeat


#######################################################################
#
# Differential Algebraic Equations (DAE)
#
#######################################################################
class DynamicScissorSpaceDeployableDAE(nn.Module):
    def __init__(self, config, logger):
        super(DynamicScissorSpaceDeployableDAE, self).__init__()
        self.device = config.device
        self.dtype = config.dtype
        self.config = config
        self.phi_net = Phi_Net(config, logger)
        self.m_net = M_Net(config, logger)
        self.f_net = F_Net(config, logger)
        self.calculator = DynamicScissorSpaceDeployableCalculator(
            config=config, logger=logger
        )

    # Compute the dynamics of the system
    def forward(self, t, coords):
        q, qt, lambdas = torch.tensor_split(
            coords, (self.config.dof, self.config.dof * 2), dim=-1
        )

        # Compute phi_q
        phi_q = self.phi_net.get_phi_q(q)

        # Compute M and its inverse Minv
        M = self.m_net(q)

        # Compute F
        F = self.f_net(t, torch.cat([q, qt], dim=-1))

        # Compute phi_q_qt_q_qt
        phi_q_qt_q_qt = -self.phi_net.get_phi_q_qt_q_qt(q, qt)

        # Construct L
        bs = coords.shape[0]
        e0 = torch.zeros(
            bs, phi_q.shape[1], phi_q.shape[1], dtype=self.dtype, device=self.device
        )
        L1 = torch.cat([M, phi_q.permute(0, 2, 1)], dim=-1)
        L2 = torch.cat([phi_q, e0], dim=-1)
        L = torch.cat([L1, L2], dim=1)

        # Construct R
        R1 = F
        R2 = phi_q_qt_q_qt
        R = torch.cat([R1, R2], dim=-1)

        # Compute qtt qt lam
        # solution = torch.linalg.solve(L, R)
        solution = torch_linalg_solve_bug(L, R)

        qtt = solution[:, : self.config.dof]
        lambdas = solution[:, self.config.dof :]

        augmented_solution = torch.cat([qt, qtt, lambdas], dim=-1)
        return augmented_solution


#######################################################################
#
# calculating kinematic quantities by using sympy
# phi, phi_t, phi_tt
#
#######################################################################
class KinematicsCalculator:
    def __init__(self, config):
        l = config.l
        dof = config.dof
        self.t = symbols("t")
        # Define symbols for q, qt, and qtt
        q = [Function(f"q{i}")(self.t) for i in range(dof)]
        qt = [q_var.diff(self.t) for q_var in q]
        qtt = [q_var.diff(self.t, self.t) for q_var in q]
        # Define phi expressions

        def phi_expr():
            phi = zeros(10 + 19 * config.unitnum, 1)
            index = 0
            phi[index] = q[0] - q[3]
            index = index + 1
            phi[index] = q[6] - q[9]
            index = index + 1
            phi[index] = q[0] + q[9]
            index = index + 1
            phi[index] = q[1] - q[10]
            index = index + 1
            phi[index] = q[4] - q[7]
            index = index + 1
            phi[index] = q[1] + q[4]
            index = index + 1
            phi[index] = q[2]
            index = index + 1
            phi[index] = q[5]
            index = index + 1
            phi[index] = q[8]
            index = index + 1
            phi[index] = q[11]

            for i in range(1, config.unitnum + 1):
                index = index + 1
                phi[index] = q[12 * i] - q[12 * i + 3]
                index = index + 1
                phi[index] = q[12 * i + 6] - q[12 * i + 9]
                index = index + 1
                phi[index] = q[0] - q[12 * i]
                index = index + 1
                phi[index] = q[6] - q[12 * i + 6]

                index = index + 1
                phi[index] = q[12 * i + 1] - q[12 * i + 10]
                index = index + 1
                phi[index] = q[12 * i + 4] - q[12 * i + 7]
                index = index + 1
                phi[index] = q[1] - q[12 * i + 1]
                index = index + 1
                phi[index] = q[4] - q[12 * i + 4]

                index = index + 1
                phi[index] = q[12 * i + 2] - q[12 * i + 5]
                index = index + 1
                phi[index] = q[12 * i + 5] - q[12 * i + 8]
                index = index + 1
                phi[index] = q[12 * i + 8] - q[12 * i + 11]

                index = index + 1
                phi[index] = (
                    (q[12 * i - 12] - q[12 * i + 3]) ** 2
                    + (q[12 * i - 11] - q[12 * i + 4]) ** 2
                    + (q[12 * i - 10] - q[12 * i + 5]) ** 2
                    - l[0] ** 2
                )
                index = index + 1
                phi[index] = (
                    (q[12 * i - 12] - q[12 * i + 9]) ** 2
                    + (q[12 * i - 11] - q[12 * i + 10]) ** 2
                    + (q[12 * i - 10] - q[12 * i + 11]) ** 2
                    - l[0] ** 2
                )
                index = index + 1
                phi[index] = (
                    (q[12 * i - 9] - q[12 * i + 0]) ** 2
                    + (q[12 * i - 8] - q[12 * i + 1]) ** 2
                    + (q[12 * i - 7] - q[12 * i + 2]) ** 2
                    - l[0] ** 2
                )
                index = index + 1
                phi[index] = (
                    (q[12 * i - 9] - q[12 * i + 6]) ** 2
                    + (q[12 * i - 8] - q[12 * i + 7]) ** 2
                    + (q[12 * i - 7] - q[12 * i + 8]) ** 2
                    - l[0] ** 2
                )
                index = index + 1
                phi[index] = (
                    (q[12 * i - 6] - q[12 * i + 3]) ** 2
                    + (q[12 * i - 5] - q[12 * i + 4]) ** 2
                    + (q[12 * i - 4] - q[12 * i + 5]) ** 2
                    - l[0] ** 2
                )
                index = index + 1
                phi[index] = (
                    (q[12 * i - 6] - q[12 * i + 9]) ** 2
                    + (q[12 * i - 5] - q[12 * i + 10]) ** 2
                    + (q[12 * i - 4] - q[12 * i + 11]) ** 2
                    - l[0] ** 2
                )
                index = index + 1
                phi[index] = (
                    (q[12 * i - 3] - q[12 * i + 0]) ** 2
                    + (q[12 * i - 2] - q[12 * i + 1]) ** 2
                    + (q[12 * i - 1] - q[12 * i + 2]) ** 2
                    - l[0] ** 2
                )
                index = index + 1
                phi[index] = (
                    (q[12 * i - 3] - q[12 * i + 6]) ** 2
                    + (q[12 * i - 2] - q[12 * i + 7]) ** 2
                    + (q[12 * i - 1] - q[12 * i + 8]) ** 2
                    - l[0] ** 2
                )

            return phi

        phi_expr = phi_expr()

        self.expr_phi = phi_expr
        self.expr_phi_fn = lambdify([q, qt, qtt], self.expr_phi, "numpy")
        self.expr_phi_t = phi_expr.diff(self.t)
        self.expr_phi_t_fn = lambdify([q, qt, qtt], self.expr_phi_t, "numpy")
        self.expr_phi_tt = phi_expr.diff(self.t, self.t)
        self.expr_phi_tt_fn = lambdify([q, qt, qtt], self.expr_phi_tt, "numpy")

    # Calculate the value of the phi function
    def get_phi(self, q_values, qt_values, qtt_values):
        phi_val = self.expr_phi_fn(q_values, qt_values, qtt_values)
        return phi_val

    # Calculate the value of the time derivative of phi function
    def get_phi_t(self, q_values, qt_values, qtt_values):
        phi_t_val = self.expr_phi_t_fn(q_values, qt_values, qtt_values)
        return phi_t_val

    # Calculate the value of the second time derivative of phi function
    def get_phi_tt(self, q_values, qt_values, qtt_values):
        phi_tt_val = self.expr_phi_tt_fn(q_values, qt_values, qtt_values)
        return phi_tt_val


#######################################################################
#
# calculating dynamics-related quantities
# energy, kinetic, potential, phi, phi_t, phi_tt
#
#######################################################################
class DynamicScissorSpaceDeployableCalculator:
    def __init__(self, config, logger):
        self.config = config
        self.logger = logger
        self.m_net = M_Net(config, logger)
        self.calculator = KinematicsCalculator(config)

    # Calculate the kinetic energy of the system
    def kinetic(self, q, qt):
        T = 0.0
        M = tensors_to_numpy(self.m_net(q))
        T = 0.5 * np.einsum("bi,bii,bi->b", qt, M, qt)
        return T

    # Calculate the potential energy of the system
    def potential(self, q, qd):
        U = np.zeros((q.shape[0],))
        return U

    # Calculate the total energy of the system
    def energy(self, q, qt):
        energy = self.kinetic(q, qt) + self.potential(q, qt)
        return energy

    # Calculate the value of the phi function
    def phi(self, q, qt, qtt):
        res = self.calculator.get_phi(q.T, qt.T, qtt.T)
        return np.array(res, dtype=np.double).squeeze().T

    # Calculate the value of the time derivative of phi function
    def phi_t(self, q, qt, qtt):
        res = self.calculator.get_phi_t(q.T, qt.T, qtt.T)
        return np.array(res, dtype=np.double).squeeze().T

    # Calculate the value of the second time derivative of phi function
    def phi_tt(self, q, qt, qtt):
        res = self.calculator.get_phi_tt(q.T, qt.T, qtt.T)
        return np.array(res, dtype=np.double).squeeze().T
